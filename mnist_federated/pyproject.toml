# =====================================================================
# For a full TOML configuration guide, check the Flower docs:
# https://flower.ai/docs/framework/how-to-configure-pyproject-toml.html
# =====================================================================

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "mnist_optimised"
version = "1.0.0"
description = "Optimised MNIST Federated Learning"
license = "Apache-2.0"
# Dependencies for your Flower App
# NOTA: flwr-datasets rimossa per compatibilitÃ  con Raspberry Pi 3/4
dependencies = [
    "flwr[simulation]>=1.22.0",
    "tensorflow==2.15.0",
    "scikit-learn==1.6.1",
    "pandas>=1.3.0",
    "matplotlib>=3.4.0",
    "seaborn>=0.11.0",
    "numpy>=1.21.0",
    "psutil>=1.0.0"
]

[tool.hatch.build.targets.wheel]
packages = ["."]

[tool.flwr.app]
publisher = "alde"

# Point to your ServerApp and ClientApp objects
# Format: "<module>:<object>"
[tool.flwr.app.components]
serverapp = "mnist_optimised.server_app:app"
clientapp = "mnist_optimised.client_app:app"

# Custom config values accessible via `context.run_config`
[tool.flwr.app.config]
num-server-rounds = 10
local-epochs = 1
batch-size = 32
fraction-fit = 1.0  # â† Usa tutti i client disponibili
fraction-evaluate = 0.0  # â† DISABILITATO di default, auto-enabled se local-val-split > 0
verbose = false
compute-aware = true  # ðŸ†• Set to true per compute-aware partitioning
partition-type = "non-iid"  # ðŸ†• "iid" or "non-iid" data distribution
classes-per-partition = 5  # ðŸ†• Per non-IID: numero di classi per client (2=estremo, 5=moderato con overlap, 7=moderato, 10=quasi IID)
local-val-split = 0.0  # ðŸ†• CLIENT-SIDE TESTING: frazione dati locali per validation (0.0=disabled, 0.2=20% validation)
experiment-name = ""  # Opzionale: nome personalizzato per l'esperimento (vuoto = auto-timestamp)
compression-type = "none"  # ðŸ†• PHASE 2: "none", "quantization", "topk"
compression-num-bits = 8  # ðŸ†• Per quantization: 8 o 16 bit
compression-k-percent = 0.1  # ðŸ†• Per topk: percentuale parametri da mantenere (0.01-1.0)
early-stopping-enabled = false  # ðŸ†• PHASE 4: Enable local early stopping
early-stopping-patience = 3  # ðŸ†• Numero di epochs senza improvement prima di stop
early-stopping-min-delta = 0.001  # ðŸ†• Miglioramento minimo per considerare "improvement"
early-stopping-adaptive = false  # ðŸ†• Se true, usa patience adattiva (alta all'inizio, bassa alla fine)

# Local simulation federation with 2 virtual SuperNodes
[tool.flwr.federations.local-simulation]
options.num-supernodes = 3

# Remote federation example for use with SuperLink
[tool.flwr.federations.remote-federation]
address = "192.168.1.121:9093"
insecure = true  # Remove this line to enable TLS
# root-certificates = "<PATH/TO/ca.crt>"  # For TLS setup

# Default federation to use when running the app
[tool.flwr.federations]
default = "local-simulation"

# Local deployment federation
[tool.flwr.federations.local-deployment]
address = "127.0.0.1:9093"
insecure = true
options.num-supernodes = 3